<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice AI - Conversation Recorder</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        .recording-indicator {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .recording-card {
            transition: all 0.3s ease;
        }
        .recording-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <div x-data="voiceAI()">
        <!-- Navigation -->
        <nav class="navbar is-primary" role="navigation" aria-label="main navigation">
            <div class="navbar-brand">
                <a class="navbar-item" href="#">
                    <i class="fas fa-microphone mr-2"></i>
                    <strong>Voice AI</strong>
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <section class="section">
            <div class="container">
                <!-- Header -->
                <div class="columns is-centered">
                    <div class="column is-8">
                        <h1 class="title has-text-centered">
                            <i class="fas fa-microphone mr-2"></i>
                            Voice AI Conversation Recorder
                        </h1>
                        <p class="subtitle has-text-centered">
                            Record conversations, get transcriptions, and AI-powered summaries
                        </p>
                    </div>
                </div>

                <!-- Recording Section -->
                <div class="columns is-centered">
                    <div class="column is-6">
                        <div class="card">
                            <div class="card-content">
                                <div class="content">
                                    <h4 class="title is-4">
                                        <i class="fas fa-microphone mr-2"></i>
                                        New Recording
                                    </h4>
                                    
                                    <!-- Recording Title Input -->
                                    <div class="field">
                                        <label class="label">Recording Title</label>
                                        <div class="control">
                                            <input 
                                                class="input" 
                                                type="text" 
                                                placeholder="Enter a title for your recording"
                                                x-model="recordingTitle"
                                                :disabled="isRecording"
                                            >
                                        </div>
                                    </div>

                                    <!-- Recording Controls -->
                                    <div class="field">
                                        <div class="control">
                                            <button 
                                                class="button is-primary is-large is-fullwidth"
                                                :class="{ 'is-danger': isRecording, 'is-loading': isProcessing }"
                                                @click="toggleRecording()"
                                                :disabled="!recordingTitle.trim() || isProcessing"
                                            >
                                                <span x-show="!isRecording">
                                                    <i class="fas fa-microphone mr-2"></i>
                                                    Start Recording
                                                </span>
                                                <span x-show="isRecording" class="recording-indicator">
                                                    <i class="fas fa-stop mr-2"></i>
                                                    Stop Recording
                                                </span>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Recording Status -->
                                    <div x-show="isRecording || isProcessing" class="notification" :class="isRecording ? 'is-warning' : 'is-info'">
                                        <div x-show="isRecording">
                                            <i class="fas fa-microphone mr-2"></i>
                                            Recording in progress... Speak clearly into your microphone.
                                        </div>
                                        <div x-show="isProcessing">
                                            <i class="fas fa-cog fa-spin mr-2"></i>
                                            Processing your recording... This may take a few moments.
                                        </div>
                                    </div>

                                    <!-- Success Message -->
                                    <div x-show="successMessage" class="notification is-success">
                                        <button class="delete" @click="successMessage = ''"></button>
                                        <i class="fas fa-check mr-2"></i>
                                        <span x-text="successMessage"></span>
                                    </div>

                                    <!-- Error Message -->
                                    <div x-show="errorMessage" class="notification is-danger">
                                        <button class="delete" @click="errorMessage = ''"></button>
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        <span x-text="errorMessage"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recordings List -->
                <div class="columns is-centered mt-6">
                    <div class="column is-10">
                        <h3 class="title is-3">
                            <i class="fas fa-list mr-2"></i>
                            Your Recordings
                        </h3>
                        
                        <div class="field">
                            <div class="control">
                                <button 
                                    class="button is-info"
                                    @click="loadRecordings()"
                                    :class="{ 'is-loading': isLoading }"
                                >
                                    <i class="fas fa-sync-alt mr-2"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div x-show="isLoading" class="has-text-centered">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">Loading recordings...</p>
                        </div>

                        <!-- Recordings Grid -->
                        <div x-show="!isLoading" class="columns is-multiline">
                            <template x-for="recording in recordings" :key="recording.id">
                                <div class="column is-4">
                                    <div class="card recording-card">
                                        <div class="card-content">
                                            <div class="content">
                                                <h5 class="title is-5" x-text="recording.title"></h5>
                                                <p class="has-text-grey-light is-size-7">
                                                    <i class="fas fa-calendar mr-1"></i>
                                                    <span x-text="new Date(recording.created_at).toLocaleString()"></span>
                                                </p>
                                                
                                                <!-- Status Indicators -->
                                                <div class="tags mt-3">
                                                    <span class="tag" :class="recording.transcription ? 'is-success' : 'is-warning'">
                                                        <i class="fas fa-file-text mr-1"></i>
                                                        <span x-text="recording.transcription ? 'Transcribed' : 'Processing...'"></span>
                                                    </span>
                                                    <span class="tag" :class="recording.summary ? 'is-success' : 'is-warning'">
                                                        <i class="fas fa-brain mr-1"></i>
                                                        <span x-text="recording.summary ? 'Summarized' : 'Processing...'"></span>
                                                    </span>
                                                </div>

                                                <!-- Transcription Preview -->
                                                <div x-show="recording.transcription" class="mt-3">
                                                    <h6 class="title is-6">Transcription:</h6>
                                                    <p class="is-size-7" x-text="recording.transcription.substring(0, 100) + (recording.transcription.length > 100 ? '...' : '')"></p>
                                                </div>

                                                <!-- Summary Preview -->
                                                <div x-show="recording.summary" class="mt-3">
                                                    <h6 class="title is-6">Summary:</h6>
                                                    <p class="is-size-7" x-text="recording.summary.substring(0, 100) + (recording.summary.length > 100 ? '...' : '')"></p>
                                                </div>

                                                <!-- View Details Button -->
                                                <div class="mt-4">
                                                    <button 
                                                        class="button is-small is-outlined is-fullwidth"
                                                        @click="viewRecording(recording.id)"
                                                    >
                                                        <i class="fas fa-eye mr-1"></i>
                                                        View Details
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Empty State -->
                        <div x-show="!isLoading && recordings.length === 0" class="has-text-centered">
                            <i class="fas fa-microphone-slash fa-3x has-text-grey-light"></i>
                            <p class="title is-4 has-text-grey-light mt-3">No recordings yet</p>
                            <p class="subtitle is-6 has-text-grey-light">Start your first recording above!</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Recording Details Modal -->
        <div x-show="selectedRecording" class="modal is-active">
            <div class="modal-background" @click="selectedRecording = null"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title" x-text="selectedRecording?.title"></p>
                    <button class="delete" aria-label="close" @click="selectedRecording = null"></button>
                </header>
                <section class="modal-card-body">
                    <div x-show="selectedRecording?.transcription">
                        <h6 class="title is-6">Full Transcription:</h6>
                        <div class="box">
                            <p x-text="selectedRecording.transcription"></p>
                        </div>
                    </div>
                    
                    <div x-show="selectedRecording?.summary" class="mt-4">
                        <h6 class="title is-6">AI Summary:</h6>
                        <div class="box has-background-info-light">
                            <p x-text="selectedRecording.summary"></p>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        function voiceAI() {
            return {
                recordingTitle: '',
                isRecording: false,
                isProcessing: false,
                isLoading: false,
                recordings: [],
                selectedRecording: null,
                successMessage: '',
                errorMessage: '',
                mediaRecorder: null,
                audioChunks: [],

                async init() {
                    await this.loadRecordings();
                },

                async toggleRecording() {
                    if (this.isRecording) {
                        await this.stopRecording();
                    } else {
                        await this.startRecording();
                    }
                },

                async startRecording() {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.mediaRecorder = new MediaRecorder(stream);
                        this.audioChunks = [];

                        this.mediaRecorder.ondataavailable = (event) => {
                            this.audioChunks.push(event.data);
                        };

                        this.mediaRecorder.onstop = async () => {
                            await this.processRecording();
                        };

                        this.mediaRecorder.start();
                        this.isRecording = true;
                        this.errorMessage = '';
                    } catch (error) {
                        this.errorMessage = 'Failed to access microphone: ' + error.message;
                    }
                },

                async stopRecording() {
                    if (this.mediaRecorder && this.isRecording) {
                        this.mediaRecorder.stop();
                        this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
                        this.isRecording = false;
                        this.isProcessing = true;
                    }
                },

                async processRecording() {
                    try {
                        const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
                        const reader = new FileReader();
                        
                        reader.onload = async () => {
                            const base64Audio = reader.result.split(',')[1];
                            
                            const response = await fetch('/api/record', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    title: this.recordingTitle,
                                    audio_data: base64Audio
                                })
                            });

                            const result = await response.json();
                            
                            if (result.success) {
                                this.successMessage = result.data.message;
                                this.recordingTitle = '';
                                await this.loadRecordings();
                            } else {
                                this.errorMessage = result.error || 'Failed to save recording';
                            }
                            
                            this.isProcessing = false;
                        };
                        
                        reader.readAsDataURL(audioBlob);
                    } catch (error) {
                        this.errorMessage = 'Failed to process recording: ' + error.message;
                        this.isProcessing = false;
                    }
                },

                async loadRecordings() {
                    this.isLoading = true;
                    try {
                        const response = await fetch('/api/recordings');
                        const result = await response.json();
                        
                        if (result.success) {
                            this.recordings = result.data || [];
                        } else {
                            this.errorMessage = result.error || 'Failed to load recordings';
                        }
                    } catch (error) {
                        this.errorMessage = 'Failed to load recordings: ' + error.message;
                    } finally {
                        this.isLoading = false;
                    }
                },

                async viewRecording(id) {
                    try {
                        const response = await fetch(`/api/recordings/${id}`);
                        const result = await response.json();
                        
                        if (result.success) {
                            this.selectedRecording = result.data;
                        } else {
                            this.errorMessage = result.error || 'Failed to load recording details';
                        }
                    } catch (error) {
                        this.errorMessage = 'Failed to load recording details: ' + error.message;
                    }
                }
            }
        }
    </script>
</body>
</html>